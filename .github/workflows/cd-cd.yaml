name: CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop

jobs:
  build:
    runs-on: self-hosted
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Allow script execution
        run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Test/Build with Maven
        run: mvn clean install

  registry_image:
    needs: build
    uses: ./.github/workflows/registry-image.yml
    with:
      ref: ${{ github.sha }}
    secrets: inherit

  deploy:
    runs-on: self-hosted
    needs:
      - registry_image
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Retrieve Checkout code
        uses: actions/checkout@v4

      - name: Allow script execution
        run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to Kubernetes
        env:
          IMAGE_TAG: ${{ needs.registry_image.outputs.image_tag }}
        run: |
          if (-not $env:IMAGE_TAG) {
            Write-Error "IMAGE_TAG output from registry-image workflow is empty."
            exit 1
          }
          ./scripts/minikube-deploy.ps1 -ImageTag $env:IMAGE_TAG

      - name: Check cluster status
        run: kubectl cluster-info

      - name: Wait for pods to be ready
        run: |
          Write-Host "Waiting for pods to be ready..."
          kubectl wait --for=condition=available --timeout=120s deployment/coffeequeue-app -n default

      - name: Check pod status
        run: |
          kubectl get pods -n default
          kubectl describe pods -n default

      - name: Get logs for app pods
        run: |
          $podNames = kubectl get pods -n default -l app=coffeequeue-app -o jsonpath="{.items[*].metadata.name}"
          if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrWhiteSpace($podNames)) {
            Write-Warning "Unable to fetch app pod names, skipping log collection."
            $global:LASTEXITCODE = 0
          } else {
            foreach ($pod in $podNames -split '\\s+') {
              if ([string]::IsNullOrWhiteSpace($pod)) { continue }
              Write-Host "Logs for pod: $pod"
              kubectl logs $pod -n default
              if ($LASTEXITCODE -ne 0) {
                Write-Warning "Failed to fetch logs for $pod."
                $global:LASTEXITCODE = 0
              }
            }
          }

      - name: Get logs for Postgres
        run: |
          $postgresPods = kubectl get pods -n default -l app=postgres -o jsonpath="{.items[*].metadata.name}"
          if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrWhiteSpace($postgresPods)) {
            Write-Warning "Unable to fetch Postgres pod names, skipping log collection."
            exit 0
          }

          foreach ($pod in $postgresPods -split '\s+') {
            if ([string]::IsNullOrWhiteSpace($pod)) { continue }
            Write-Host "Postgres logs for pod: $pod"
            kubectl logs $pod -n default
            if ($LASTEXITCODE -ne 0) {
              Write-Warning "Failed to fetch logs for Postgres pod $pod."
              $global:LASTEXITCODE = 0
            }
          }
