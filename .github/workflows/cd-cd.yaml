name: CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  build:
    runs-on: self-hosted
    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Allow script execution
        run: Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass

      - name: Build with Maven
        run: mvn clean install

      - name: Run tests
        run: mvn test

      - name: Build and push Docker image
        run: ./scripts/docker-build-push.ps1

      - name: Deploy to Kubernetes
        run: ./scripts/minikube-deploy.ps1

      - name: Check cluster status
        run: kubectl cluster-info

      - name: Wait for pods to be ready
        run: |
          Write-Host "Waiting for pods to be ready..."
          kubectl wait --for=condition=available --timeout=120s deployment/coffeequeue-app -n default
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "kubectl wait failed but continuing."
            $global:LASTEXITCODE = 0
          }

      - name: Check pod status
        run: |
          kubectl get pods -n default
          kubectl describe pods -n default

      - name: Get logs for app pods
        run: |
          $podNames = kubectl get pods -n default -l app=coffeequeue-app -o jsonpath="{.items[*].metadata.name}"
          if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrWhiteSpace($podNames)) {
            Write-Warning "Unable to fetch app pod names, skipping log collection."
            $global:LASTEXITCODE = 0
          } else {
            foreach ($pod in $podNames -split '\s+') {
              if ([string]::IsNullOrWhiteSpace($pod)) { continue }
              Write-Host "Logs for pod: $pod"
              kubectl logs $pod -n default
              if ($LASTEXITCODE -ne 0) {
                Write-Warning "Failed to fetch logs for $pod."
                $global:LASTEXITCODE = 0
              }
            }
          }

      - name: Get logs for Postgres
        run: |
          Write-Host "Postgres logs:"
          kubectl logs deployment/postgres -n default
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "Failed to fetch Postgres logs."
            $global:LASTEXITCODE = 0
          }
